<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cardiac Efficiency · Strava Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f0e;
    --surface: #141716;
    --surface2: #1c1f1d;
    --border: #2a2e2b;
    --text: #e8ede9;
    --muted: #6b7369;
    --cycling: #c8f04a;
    --running: #4af0c8;
    --grid: #1e211f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    padding: 2rem;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .content { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; }

  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 3rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .title-block h1 {
    font-family: 'Fraunces', serif;
    font-weight: 300;
    font-size: 2.8rem;
    letter-spacing: -0.02em;
    line-height: 1;
  }

  .title-block h1 em { font-style: italic; color: var(--cycling); }

  .title-block p {
    color: var(--muted);
    font-size: 0.72rem;
    margin-top: 0.5rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .header-actions { display: flex; align-items: center; gap: 1rem; }

  #status { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em; }

  button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.6rem 1.2rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  button:hover { border-color: var(--cycling); color: var(--cycling); }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Auth screen */
  .auth-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1.5rem;
    text-align: center;
  }

  .auth-screen h2 {
    font-family: 'Fraunces', serif;
    font-weight: 300;
    font-size: 1.6rem;
  }

  .auth-screen p { color: var(--muted); font-size: 0.8rem; line-height: 1.8; max-width: 420px; }

  .strava-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.8rem;
    background: #fc4c02;
    border: none;
    color: #fff;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.9rem 2rem;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .strava-btn:hover { opacity: 0.85; border: none; color: #fff; }

  .strava-btn svg { width: 20px; height: 20px; fill: currentColor; }

  /* Stats */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.2rem 1.4rem;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .stat-card.cycling::before { background: var(--cycling); }
  .stat-card.running::before { background: var(--running); }

  .stat-label {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.6rem;
  }

  .stat-value {
    font-family: 'Fraunces', serif;
    font-weight: 600;
    font-size: 2rem;
    line-height: 1;
  }

  .stat-value.cycling { color: var(--cycling); }
  .stat-value.running { color: var(--running); }
  .stat-sub { font-size: 0.65rem; color: var(--muted); margin-top: 0.3rem; }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
  }

  .chart-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 1.2rem;
  }

  .chart-title {
    font-family: 'Fraunces', serif;
    font-weight: 300;
    font-size: 1.1rem;
  }

  .chart-title .unit {
    font-size: 0.7rem;
    color: var(--muted);
    margin-left: 0.5rem;
    font-family: 'DM Mono', monospace;
  }

  .chart-count { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; }
  .chart-container { position: relative; height: 280px; }

  .trend-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Loading */
  .loading {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0.8rem;
    padding: 3rem;
    color: var(--muted);
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .loading.active { display: flex; }

  .spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--cycling);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    display: none;
    background: #1a0a0e;
    border: 1px solid #4a1020;
    color: #f04a7a;
    padding: 1rem 1.2rem;
    font-size: 0.8rem;
    margin-bottom: 1.5rem;
  }

  .error-msg.active { display: block; }

  .dot {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    margin-right: 0.4rem;
  }
  .dot.cycling { background: var(--cycling); }
  .dot.running { background: var(--running); }

  .logout-btn {
    font-size: 0.65rem;
    padding: 0.4rem 0.8rem;
    color: var(--muted);
    border-color: var(--border);
  }
</style>
</head>
<body>
<div class="content">

  <header>
    <div class="title-block">
      <h1>cardiac <em>efficiency</em></h1>
      <p>Strava · Power &amp; Pace per Heartbeat · Over Time</p>
    </div>
    <div class="header-actions">
      <span id="status">—</span>
      <button id="refreshBtn" onclick="loadData()" style="display:none">↻ Refresh</button>
      <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none">Sign out</button>
    </div>
  </header>

  <!-- Auth screen -->
  <div id="authScreen" class="auth-screen">
    <h2>Connect to <em style="color:var(--cycling);font-style:italic">Strava</em></h2>
    <p>Authorise this dashboard to read your activities. Your data is fetched directly in your browser — nothing is stored on any server.</p>
    <button class="strava-btn" onclick="authoriseStrava()">
      <svg viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
      Connect with Strava
    </button>
  </div>

  <div id="errorMsg" class="error-msg"></div>
  <div id="loading" class="loading"><div class="spinner"></div><span id="loadingText">Fetching activities…</span></div>

  <div id="dashboard" style="display:none">
    <div class="stats-row">
      <div class="stat-card cycling">
        <div class="stat-label"><span class="dot cycling"></span>Avg W/bpm — Cycling</div>
        <div class="stat-value cycling" id="avgWatts">—</div>
        <div class="stat-sub">watts per heartbeat</div>
      </div>
      <div class="stat-card cycling">
        <div class="stat-label"><span class="dot cycling"></span>Best W/bpm — Cycling</div>
        <div class="stat-value cycling" id="bestWatts">—</div>
        <div class="stat-sub">peak efficiency session</div>
      </div>
      <div class="stat-card running">
        <div class="stat-label"><span class="dot running"></span>Avg m/bpm — Running</div>
        <div class="stat-value running" id="avgMeters">—</div>
        <div class="stat-sub">meters per heartbeat</div>
      </div>
      <div class="stat-card running">
        <div class="stat-label"><span class="dot running"></span>Best m/bpm — Running</div>
        <div class="stat-value running" id="bestMeters">—</div>
        <div class="stat-sub">peak efficiency session</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Cycling Efficiency <span class="unit">W / bpm</span></div>
          <span class="chart-count" id="cyclingCount">0 sessions</span>
        </div>
        <div class="chart-container"><canvas id="cyclingChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Running Efficiency <span class="unit">m / bpm</span></div>
          <span class="chart-count" id="runningCount">0 sessions</span>
        </div>
        <div class="chart-container"><canvas id="runningChart"></canvas></div>
      </div>
    </div>

    <div class="trend-card">
      <div class="chart-header">
        <div class="chart-title">Rolling 4-Week Trend <span class="unit">% change from baseline</span></div>
      </div>
      <div class="chart-container" style="height:200px"><canvas id="trendChart"></canvas></div>
    </div>
  </div>

</div>

<script>
// ── Config ────────────────────────────────────────────────────────────────
const CLIENT_ID = '203930';
const CLIENT_SECRET = '8d25e65d23c2bd0ebf7d0b3cd9dac4b7b7b69ada';
const REDIRECT_URI = 'https://the1endgame.github.io/efficiency-dashboard';

// ── Storage ───────────────────────────────────────────────────────────────
const LS = {
  save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} },
  load(k){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch(e){ return null; } },
  remove(k){ try{ localStorage.removeItem(k); }catch(e){} }
};

// ── Init ──────────────────────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  // Check if Strava redirected back with ?code=
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if(code){
    history.replaceState(null, '', window.location.pathname);
    showLoading(true);
    setLoadingText('Exchanging auth code…');
    try {
      const r = await fetch('https://www.strava.com/oauth/token', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
          code,
          grant_type: 'authorization_code'
        })
      });
      const data = await r.json();
      if(!data.access_token) throw new Error(data.message || 'Token exchange failed');
      LS.save('strava_token', data.access_token);
      LS.save('strava_refresh', data.refresh_token);
      showLoading(false);
      startDashboard(data.access_token);
    } catch(e){
      showLoading(false);
      showError('Auth failed: ' + e.message);
      showAuth();
    }
    return;
  }

  const saved = LS.load('strava_token');
  if(saved){
    startDashboard(saved);
  } else {
    showAuth();
  }
});

function authoriseStrava(){
  const url = `https://www.strava.com/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&approval_prompt=auto&scope=activity:read_all`;
  window.location.href = url;
}

function logout(){
  LS.remove('strava_token');
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('refreshBtn').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
  showAuth();
  setStatus('—');
}

function showAuth(){
  document.getElementById('authScreen').style.display = 'flex';
}

function startDashboard(token){
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('refreshBtn').style.display = 'inline-block';
  document.getElementById('logoutBtn').style.display = 'inline-block';
  loadData(token);
}

// ── Fetch activities ───────────────────────────────────────────────────────
async function fetchAllActivities(token){
  let page = 1, all = [];
  while(true){
    setLoadingText(`Fetching activities… (${all.length} so far)`);
    const r = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=200&page=${page}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(r.status === 401){
      LS.remove('strava_token');
      throw new Error('Session expired — please reconnect to Strava.');
    }
    if(!r.ok) throw new Error(`Strava API error ${r.status}`);
    const data = await r.json();
    if(!data.length) break;
    all = all.concat(data);
    if(data.length < 200) break;
    page++;
  }
  return all;
}

// ── Chart instances ────────────────────────────────────────────────────────
let cyclingChartInst, runningChartInst, trendChartInst;

async function loadData(token){
  token = token || LS.load('strava_token');
  if(!token){ showAuth(); return; }

  showLoading(true);
  hideError();
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('refreshBtn').disabled = true;
  setStatus('Loading…');

  try {
    const activities = await fetchAllActivities(token);

    const cycling = [], running = [];

    for(const a of activities){
      const date = new Date(a.start_date);
      const sport = (a.sport_type || a.type || '').toLowerCase();

      if(['ride','virtualride','ebikeride'].includes(sport) && a.average_watts && a.average_heartrate){
        cycling.push({
          date,
          label: formatDate(date),
          name: a.name,
          efficiency: +(a.average_watts / a.average_heartrate).toFixed(3),
          watts: a.average_watts,
          hr: a.average_heartrate,
        });
      }

      if(['run','virtualrun','trailrun'].includes(sport) && a.distance && a.average_heartrate && a.moving_time){
        const totalBeats = a.average_heartrate * (a.moving_time / 60);
        running.push({
          date,
          label: formatDate(date),
          name: a.name,
          efficiency: +(a.distance / totalBeats).toFixed(3),
          distance: a.distance,
          hr: a.average_heartrate,
          duration: a.moving_time,
        });
      }
    }

    cycling.sort((a,b) => a.date - b.date);
    running.sort((a,b) => a.date - b.date);

    // Stats
    const avg = arr => arr.reduce((s,x)=>s+x.efficiency,0)/arr.length;
    const best = arr => Math.max(...arr.map(x=>x.efficiency));

    document.getElementById('avgWatts').textContent  = cycling.length ? avg(cycling).toFixed(3) : '—';
    document.getElementById('bestWatts').textContent = cycling.length ? best(cycling).toFixed(3) : '—';
    document.getElementById('avgMeters').textContent  = running.length ? avg(running).toFixed(3) : '—';
    document.getElementById('bestMeters').textContent = running.length ? best(running).toFixed(3) : '—';
    document.getElementById('cyclingCount').textContent = `${cycling.length} sessions`;
    document.getElementById('runningCount').textContent = `${running.length} sessions`;

    // Chart base config
    const baseOpts = (labelFn) => ({
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1c1f1d',
          borderColor: '#2a2e2b',
          borderWidth: 1,
          titleColor: '#6b7369',
          bodyColor: '#e8ede9',
          titleFont: { family: 'DM Mono', size: 11 },
          bodyFont:  { family: 'DM Mono', size: 12 },
          padding: 10,
          callbacks: { label: labelFn }
        }
      },
      scales: {
        x: {
          ticks: { color:'#6b7369', font:{family:'DM Mono',size:10}, maxTicksLimit:8 },
          grid:  { color:'#1e211f' },
          border:{ color:'#2a2e2b' }
        },
        y: {
          ticks: { color:'#6b7369', font:{family:'DM Mono',size:10} },
          grid:  { color:'#1e211f' },
          border:{ color:'#2a2e2b' }
        }
      }
    });

    if(cyclingChartInst) cyclingChartInst.destroy();
    cyclingChartInst = new Chart(document.getElementById('cyclingChart'), {
      type: 'line',
      data: {
        labels: cycling.map(x=>x.label),
        datasets: [{
          data: cycling.map(x=>x.efficiency),
          borderColor: '#c8f04a',
          backgroundColor: 'rgba(200,240,74,0.08)',
          pointBackgroundColor: '#c8f04a',
          pointRadius: 4, pointHoverRadius: 6,
          borderWidth: 1.5, fill: true, tension: 0.3,
        }]
      },
      options: baseOpts((item) => {
        const d = cycling[item.dataIndex];
        return [`${item.raw} W/bpm`, `Power: ${d.watts}W`, `HR: ${d.hr} bpm`, d.name];
      })
    });

    if(runningChartInst) runningChartInst.destroy();
    runningChartInst = new Chart(document.getElementById('runningChart'), {
      type: 'line',
      data: {
        labels: running.map(x=>x.label),
        datasets: [{
          data: running.map(x=>x.efficiency),
          borderColor: '#4af0c8',
          backgroundColor: 'rgba(74,240,200,0.08)',
          pointBackgroundColor: '#4af0c8',
          pointRadius: 4, pointHoverRadius: 6,
          borderWidth: 1.5, fill: true, tension: 0.3,
        }]
      },
      options: baseOpts((item) => {
        const d = running[item.dataIndex];
        return [`${item.raw} m/bpm`, `${(d.distance/1000).toFixed(2)} km`, `HR: ${d.hr} bpm`, d.name];
      })
    });

    // Rolling 4-week trend
    const trend = buildTrend(cycling, running);
    if(trendChartInst) trendChartInst.destroy();
    trendChartInst = new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: trend.labels,
        datasets: [
          { label:'Cycling', data:trend.cycling, borderColor:'#c8f04a', pointRadius:2, borderWidth:1.5, tension:0.4, fill:false },
          { label:'Running', data:trend.running, borderColor:'#4af0c8', pointRadius:2, borderWidth:1.5, tension:0.4, fill:false }
        ]
      },
      options: {
        ...baseOpts(item => `${item.raw}%`),
        plugins: {
          ...baseOpts().plugins,
          legend: {
            display: true,
            labels: { color:'#6b7369', font:{family:'DM Mono',size:11}, boxWidth:20 }
          },
          tooltip: {
            backgroundColor:'#1c1f1d', borderColor:'#2a2e2b', borderWidth:1,
            titleColor:'#6b7369', bodyColor:'#e8ede9',
            titleFont:{family:'DM Mono',size:11}, bodyFont:{family:'DM Mono',size:12}, padding:10
          }
        }
      }
    });

    setStatus(`Updated ${new Date().toLocaleTimeString()} · ${activities.length} activities`);
    document.getElementById('dashboard').style.display = 'block';

  } catch(err){
    showError(err.message);
    setStatus('Error');
    if(err.message.includes('reconnect')){
      setTimeout(() => { document.getElementById('authScreen').style.display='flex'; }, 1500);
    }
  } finally {
    showLoading(false);
    document.getElementById('refreshBtn').disabled = false;
  }
}

function buildTrend(cycling, running){
  const allDates = [...cycling,...running].map(x=>x.date);
  if(!allDates.length) return {labels:[],cycling:[],running:[]};

  const minDate = new Date(Math.min(...allDates));
  const maxDate = new Date(Math.max(...allDates));
  const weeks = [];
  const d = new Date(minDate);
  while(d <= maxDate){ weeks.push(new Date(d)); d.setDate(d.getDate()+7); }

  const rolling = (arr, weekEnd) => {
    const start = new Date(weekEnd);
    start.setDate(start.getDate()-28);
    const w = arr.filter(x => x.date>=start && x.date<=weekEnd);
    return w.length ? w.reduce((s,x)=>s+x.efficiency,0)/w.length : null;
  };

  const normalise = vals => {
    const first = vals.find(v=>v!==null);
    if(!first) return vals;
    return vals.map(v => v===null ? null : +((v/first-1)*100).toFixed(2));
  };

  return {
    labels: weeks.map(w=>formatDate(w)),
    cycling: normalise(weeks.map(w=>rolling(cycling,w))),
    running: normalise(weeks.map(w=>rolling(running,w))),
  };
}

function formatDate(d){
  return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'});
}

function showLoading(on){ document.getElementById('loading').classList.toggle('active',on); }
function setLoadingText(t){ document.getElementById('loadingText').textContent = t; }
function showError(msg){ const e=document.getElementById('errorMsg'); e.textContent=msg; e.classList.add('active'); }
function hideError(){ document.getElementById('errorMsg').classList.remove('active'); }
function setStatus(t){ document.getElementById('status').textContent = t; }
</script>
</body>
</html>
